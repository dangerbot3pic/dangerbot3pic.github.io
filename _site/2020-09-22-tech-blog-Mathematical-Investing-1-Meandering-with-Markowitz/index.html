<!DOCTYPE html>
<html lang="en">
  <!-- Beautiful Jekyll | MIT license | Copyright Dean Attali 2020 -->
  <head>
  <script type="text/javascript" async
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML">
</script>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>Mathematical Investing 1 - Meandering with Markowitz</title>
  
  
  <meta name="author" content="Padmanaba Srinivasan">
  
  
  
  <meta name="description" content="Using Linear Algebra to choose the best investments">
  

  <link rel="alternate" type="application/rss+xml" title="Padmanaba Srinivasan - Computer Science PhD Student" href="http://localhost:4000/feed.xml">

  

  

  <!-- Global site tag (gtag.js) - Google Analytics -->
<!--
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-172123502-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-172123502-1');
</script>

-->

  
    
      
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">


    
      
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css">


    
      
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic">


    
      
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800">


    
  

  
    
      <link rel="stylesheet" href="/assets/css/bootstrap-social.css">
    
      <link rel="stylesheet" href="/assets/css/main.css">
    
  

  

  

  <!-- Facebook OpenGraph tags -->
  

  
  <meta property="og:title" content="Mathematical Investing 1 - Meandering with Markowitz">
  

   
  <meta property="og:description" content="Using Linear Algebra to choose the best investments">
  


  
  <meta property="og:type" content="article">
  <meta property="og:article:author" content="Padmanaba Srinivasan">
  <meta property="og:article:published_time" content="2020-09-22T00:00:00+01:00">
  

  
  <meta property="og:url" content="http://localhost:4000/2020-09-22-tech-blog-Mathematical-Investing-1-Meandering-with-Markowitz/">
  <link rel="canonical" href="http://localhost:4000/2020-09-22-tech-blog-Mathematical-Investing-1-Meandering-with-Markowitz/">
  
  

  
  <meta property="og:image" content="http://localhost:4000/assets/img/path.jpg">
  


  <!-- Twitter summary cards -->
  
  <meta name="twitter:card" content="summary_large_image">
  
  <meta name="twitter:site" content="@">
  <meta name="twitter:creator" content="@">

  
  <meta name="twitter:title" content="Mathematical Investing 1 - Meandering with Markowitz">
  

  
  <meta name="twitter:description" content="Using Linear Algebra to choose the best investments">
  

  
  <meta name="twitter:image" content="http://localhost:4000/assets/img/path.jpg">
  

  

  

</head>


  <body>

    

  
    <nav class="navbar navbar-expand-md navbar-light fixed-top navbar-custom "><a class="navbar-brand" href="http://localhost:4000/">Padmanaba Srinivasan</a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  <div class="collapse navbar-collapse" id="main-navbar">
    <ul class="navbar-nav ml-auto">
          <li class="nav-item">
            <a class="nav-link" href="/cv/CV.pdf">CV/Resume</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/aboutme">About Me</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/techblog">Blog</a>
          </li></ul>
  </div>

  
    <div class="avatar-container">
      <div class="avatar-img-border">
        <a href="http://localhost:4000/">
          <img alt="Navbar avatar" class="avatar-img" src="/assets/img/park.jpg" />
        </a>
      </div>
    </div>
  

</nav>


    <!-- TODO this file has become a mess, refactor it -->






  <div id="header-big-imgs" data-num-img=1
    
    
    
      
      data-img-src-1="http://localhost:4000/assets/img/path.jpg"
    
    
    
  ></div>


<header class="header-section has-img">

<div class="big-img intro-header">
  <div class="container-md">
    <div class="row">
      <div class="col-xl-8 offset-xl-2 col-lg-10 offset-lg-1">
        <div class="post-heading">
          <h1>Mathematical Investing 1 - Meandering with Markowitz</h1>
      
        
      <h2 class="post-subheading">Using Linear Algebra to choose the best investments</h2>
      
      
      
      
          <span class="post-meta">Posted on 22 September, 2020</span>
          
      
        </div>
      </div>
    </div>
  </div>
  <span class='img-desc'></span>
</div>

<div class="intro-header no-img">
  <div class="container-md">
    <div class="row">
      <div class="col-xl-8 offset-xl-2 col-lg-10 offset-lg-1">
        <div class="post-heading">
          <h1>Mathematical Investing 1 - Meandering with Markowitz</h1>
      
        
      <h2 class="post-subheading">Using Linear Algebra to choose the best investments</h2>
      
      
      
      
          <span class="post-meta">Posted on 22 September, 2020</span>
          
      
        </div>
      </div>
    </div>
  </div>
</div>
</header>





<div class="container-md">
  <div class="row">
    <div class="col-xl-8 offset-xl-2 col-lg-10 offset-lg-1">

      

      <article role="main" class="blog-post">
        <p>This post, and indeed the successive posts in this series are focused on portfolio optimisation. <a href="https://en.wikipedia.org/wiki/Harry_Markowitz">Harry Markowitz</a> is credited with developing the field of <a href="https://en.wikipedia.org/wiki/Modern_portfolio_theory">Modern Portfolio Theory</a>, and won the Nobel Prize in Economics for developing the Markowitz Model (Minimum-Variance).</p>

<h3 id="understanding-return-and-risk">Understanding Return and Risk</h3>

<p>When we look at an investment opportunity, we are concerned only with the Return offered by the venture and the risk associated with it. Return or Return on Investment (ROI) is a measure of how much as a percentage we expect to earn from an initial investment.</p>

<script type="math/tex; mode=display">\begin{align}
 ROI = \frac{\text{final value of investment} - \text{initial value of investment}}{\text{cost of investment}} \times 100\%
 \end{align}</script>

<p>When looking at a series of returns, such as daily stock returns over the past <em>k</em> days we may see something like this:</p>

<p class="mx-auto d-block"><img src="/assets/blog/tech_blog/2020-09-22-tech-blog-Mathematical-Investing-1-Meandering-with-Markowitz/returns.png" alt="AAPL daily returns $$" />
<em>AAPL daily returns</em></p>

<p>We expect returns to be normally distributed with some mean <script type="math/tex">\mu</script> and standard deviation <script type="math/tex">\sigma</script>.</p>

<p class="mx-auto d-block"><img src="/assets/blog/tech_blog/2020-09-22-tech-blog-Mathematical-Investing-1-Meandering-with-Markowitz/distplot.png" alt="AAPL returns distribution $$" />
<em>AAPL returns distribution</em></p>

<p>The returns distribution is a little different to the Normal distribution plotted and this is because we don’t consider the higher moments.</p>

<p>AAPL’s returns here show a mean (expected) daily return of 0.13% and a standard deviation of 1.8%. The standard deviation of a distribution represents the spread of the values around the mean and as a result, this is a direct measure of the volatility of the returns of a security. Generally, an increase in volatility corresponds to an increase in risk and Markowitz argues that volatility can be taken as a proxy for risk and so standard deviation can be used instead of risk in calculations.</p>

<p>When presented with a world of stocks, such as some of the constituents of the S&amp;P 500, we turn to linear algebra to keep notation concise. For a single stock the mean return, <script type="math/tex">\mu</script> is a scalar value and when extended to multiple stocks corresponds to a vector:</p>

<script type="math/tex; mode=display">\begin{align}
 \mu = 
 \begin{bmatrix}
 \mu_1 \\
 \mu_2 \\
 ... \\
 \mu_n
 \end{bmatrix}
 \end{align}</script>

<p>We also define the covariance matrix, <script type="math/tex">\Sigma</script>, which is a measure of the linear relationship of the returns between two assets.</p>

<script type="math/tex; mode=display">% <![CDATA[
\begin{align}
 \Sigma = \left[
 \begin{array}{ccc}
 \sigma_{11} & \cdots & \sigma_{1n} \\
 \vdots & \ddots & \vdots \\
 \sigma_{n1} & \cdots & \sigma_{nn}
 \end{array}
 \right]
 \end{align} %]]></script>

<h3 id="an-important-note">An important note!</h3>

<p>When discussing returns in this post, we assume linear returns only. Log-returns are another method for calculating returns and the Portfolio Theory used here will not work for log-returns without modification.</p>

<h3 id="investment-objectives">Investment Objectives</h3>

<p>When making an investment, intuitively, we want to choose investments that minimise risk (perhaps while also achieving a certain level of return). When choosing which stocks to invest in from a world of stocks, if we being with initial capital <em>c</em>, we want to find the best possible way of allocating portions of this money to buying a selection of stocks such that we satisfy our investment objectives. Rather than solving the problem of exactly how much capital to allocate to buying each stock, we instead solve the problem of what proportion of the initial capital should be allocated to each stock. We define a weight vector, <script type="math/tex">w</script>, which allows this.</p>

<script type="math/tex; mode=display">\begin{align}
 w = 
 \begin{bmatrix}
 w_1 \\
 w_2 \\
 ... \\
 w_n
 \end{bmatrix}
 \end{align}</script>

<p>Now, to ensure that we are investing only the money we have we have to apply the constraint that the sum of the values in the weight vector is equal to 1.</p>

<script type="math/tex; mode=display">\begin{align}
 \sum_{i = 1}^{n} w_i = e^Tw= w^Te = 1
 \end{align}</script>

<p>Where <script type="math/tex">e</script> is a vector of ones.</p>

<p>Given the covariance matrix, we can calculate the variance of a portfolio defined by weights <script type="math/tex">w</script> using:</p>

<script type="math/tex; mode=display">\begin{align}
 variance = w^T \Sigma w
 \end{align}</script>

<p>Similarly, we can also calculate the expected returns of a portfolio as:</p>

<script type="math/tex; mode=display">\begin{align}
 return = w^T \mu = \mu^T w
 \end{align}</script>

<p>Now that we have found a way of defining portions of our objective mathematically, we can solve our investment problem mathematically. As stated before, we want to minimise the risk associated with our portfolio while at the same time achieving a particular level of return.</p>

<p>We can start this off as a minimisation problem and add constraints that demand a level of return and place limits on the available capital.</p>

<script type="math/tex; mode=display">\begin{align}
 \underset{w}{\mathrm{argmin}}\ w^T \Sigma w\\
 \mathrm{subject\ to} \\
 w^T \mu = r \\
 w^T e = 1
 \end{align}</script>

<p>We choose to solve this problem as it can be done parametrically. We rewrite the problem slightly as follows:</p>

<script type="math/tex; mode=display">\begin{align}
 \underset{w}{\mathrm{argmin}}\ \frac{1}{2}w^T \Sigma w\\
 \mathrm{subject\ to} \\
 w^T \mu - r = 0 \\
 w^T e - 1 = 0
 \end{align}</script>

<p>Note that we introduce a factor of <script type="math/tex">\frac{1}{2}</script> into the minimisation problem as this cancels out a multiplier constant (as we will see) as well as move all the values to one side of the equation in the constraints. We are now ready to solve this problem. This portfolio also allows short selling of stocks as we place no requirement that each weight is positive, merely that the sum of the weights is 1.</p>

<h3 id="solving-different-optimisation-problems">Solving different optimisation problems</h3>

<p>There are many different ways of solving the problem to find an optimal portfolio. For example, we could choose that we are not interested in achieving excess (above market) returns at all and that we are extremely risk averse. In this case we could rewrite the optimisation problem as:</p>

<script type="math/tex; mode=display">\begin{align}
 \underset{w}{\mathrm{argmin}}\ \frac{1}{2}w^T \Sigma w\\
 \mathrm{subject\ to} \\
 w^T e - 1 = 0
 \end{align}</script>

<p>If we refuse to short sell stocks than we can introduce another constraint:</p>

<script type="math/tex; mode=display">\begin{align}
 w_i \geq 0\ \forall i \in \{1, 2, \dots, n\}
 \end{align}</script>

<p>We can also solve an optimisation problem to find the maximum possible return while also minimising the variance:</p>

<script type="math/tex; mode=display">\begin{align}
 \underset{w}{\mathrm{argmin}}\ \frac{1}{2}w^T \Sigma w - q w^T \mu\\
 \mathrm{subject\ to} \\
 w^T \mu - r = 0 \\
 w^T e - 1 = 0
 \end{align}</script>

<p>Where <script type="math/tex">q \in [0, \infty)</script> is a ‘risk tolerance’ factor. Some of these problems can’t be solved parametrically and require <a href="https://en.wikipedia.org/wiki/Quadratic_programming">Quadratic Programming</a> packages to solve.</p>

<h3 id="back-to-our-problem">Back to our problem</h3>

<p>We now return to our problem.</p>

<script type="math/tex; mode=display">\begin{align}
 \underset{w}{\mathrm{argmin}}\ \frac{1}{2}w^T \Sigma w\\
 \mathrm{subject\ to} \\
 w^T \mu - r = 0 \\
 w^T e - 1 = 0
 \end{align}</script>

<p>We proceed to solve this problem using <a href="https://en.wikipedia.org/wiki/Lagrange_multiplier">Lagrange Multipliers</a>, writing the Lagrangian as follows.</p>

<script type="math/tex; mode=display">\begin{align}
 L(w, \alpha, \beta) = \frac{1}{2}w^T \Sigma w - \alpha (w^T \mu - r) - \beta (w^T e -1)
 \end{align}</script>

<p>We differentiate to obtain the optimality conditions.</p>

<script type="math/tex; mode=display">\begin{align}
 \frac{dL}{dw} = \Sigma w - \alpha \mu - \beta e = 0 \\
 \frac{dL}{d \alpha} = w^T \mu - r = \mu^T w - r = 0 \\
 \frac{dL}{d \beta} = e^T w - 1 = 0
 \end{align}</script>

<p>We can rewrite the optimality conditions in one equation.</p>

<script type="math/tex; mode=display">% <![CDATA[
\begin{align}
 \begin{bmatrix}
 \Sigma & -\mu & -e \\
 -\mu^T & 0 & 0 \\
 -e^T & 0 & 0
 \end{bmatrix}

 \begin{bmatrix}
 w \\
 \alpha \\
 \beta
 \end{bmatrix}
 =
 \begin{bmatrix}
 \mathbf{0} \\
 -r \\
 -1
 \end{bmatrix}
 \end{align} %]]></script>

<p>Which we can solve by:</p>

<script type="math/tex; mode=display">% <![CDATA[
\begin{align}
 \begin{bmatrix}
 w \\
 \alpha \\
 \beta
 \end{bmatrix}
 =
 \begin{bmatrix}
 \Sigma & -\mu & -e \\
 -\mu^T & 0 & 0 \\
 -e^T & 0 & 0
 \end{bmatrix}^{-1}
 \begin{bmatrix}
 \mathbf{0} \\
 -r \\
 -1
 \end{bmatrix}
 \end{align} %]]></script>

<p>Now that we have the method to find the solution, we can start writing some code!</p>

<h3 id="finding-the-optimal-portfolio">Finding the Optimal Portfolio</h3>

<p>As we have seen, we need to look at returns for a number of stocks and from these, calculate a mean vector and covariance matrix. We begin by importing the necessary packages and getting the adjusted closing prices.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="code"><pre> <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
 <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span> 
 <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
 <span class="kn">import</span> <span class="nn">pandas_datareader.data</span> <span class="k">as</span> <span class="n">pdr</span>
 <span class="kn">import</span> <span class="nn">datetime</span> <span class="k">as</span> <span class="n">dt</span>
 <span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="n">sns</span>
 <span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>

 <span class="n">start</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2015</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
 <span class="n">end</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">date</span><span class="p">.</span><span class="n">today</span><span class="p">()</span>

 <span class="n">data</span> <span class="o">=</span> <span class="n">pdr</span><span class="p">.</span><span class="n">DataReader</span><span class="p">(</span><span class="n">nasdaq_100_tickers</span><span class="p">,</span> <span class="s">"yahoo"</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
 <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">"Adj Close"</span><span class="p">]</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>From this we calculate daily returns for each stock and split the dataset, taking the final 252 days as an Out Of Sample (OoS) test set. We make sure to calculate returns over a period of 252 days, as there are 252 (ish) working days in a year. This also lets us demand a set annual return (let’s just say we generate returns only on working days) rather than have to compute which average daily return corresponds to a required annual return.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="code"><pre> <span class="n">returns</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">pct_change</span><span class="p">().</span><span class="n">dropna</span><span class="p">()</span>
 <span class="n">test_set</span> <span class="o">=</span> <span class="n">returns</span><span class="p">[</span><span class="o">-</span><span class="mi">252</span><span class="o">*</span><span class="mi">4</span><span class="p">:]</span>
 <span class="n">train_set</span> <span class="o">=</span> <span class="n">returns</span><span class="p">[:</span><span class="o">-</span><span class="mi">252</span><span class="o">*</span><span class="mi">4</span><span class="p">]</span>
 <span class="n">mu</span> <span class="o">=</span> <span class="n">train_set</span><span class="p">.</span><span class="n">mean</span><span class="p">().</span><span class="n">values</span><span class="p">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
 <span class="n">sigma</span> <span class="o">=</span> <span class="n">train_set</span><span class="p">.</span><span class="n">cov</span><span class="p">().</span><span class="n">values</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Next, we construct the augmented matrices that we need to solve our problem.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="code"><pre> <span class="n">r</span> <span class="o">=</span> <span class="mf">0.25</span> <span class="c1"># Required return
</span> <span class="n">num_stocks</span> <span class="o">=</span> <span class="n">returns</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
 <span class="n">e</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">ones</span><span class="p">(</span><span class="n">num_stocks</span><span class="p">).</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
 <span class="n">zero</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_stocks</span><span class="p">).</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
 <span class="n">one</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">1</span><span class="p">]]</span>
 <span class="n">zero</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">]]</span>
 <span class="n">zero_vec</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_stocks</span><span class="p">).</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

 <span class="n">augL</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">vstack</span><span class="p">(</span> <span class="p">(</span> <span class="n">np</span><span class="p">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">sigma</span><span class="p">,</span> <span class="o">-</span><span class="n">mu</span><span class="p">,</span> <span class="n">e</span><span class="p">)),</span> <span class="n">np</span><span class="p">.</span><span class="n">hstack</span><span class="p">((</span><span class="o">-</span><span class="n">mu</span><span class="p">.</span><span class="n">T</span><span class="p">,</span> <span class="n">zero</span><span class="p">,</span> <span class="n">zero</span><span class="p">)),</span> <span class="n">np</span><span class="p">.</span><span class="n">hstack</span><span class="p">((</span><span class="o">-</span><span class="n">e</span><span class="p">.</span><span class="n">T</span><span class="p">,</span> <span class="n">zero</span><span class="p">,</span> <span class="n">zero</span><span class="p">))</span> <span class="p">)</span> <span class="p">)</span>
 <span class="n">augR</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">vstack</span><span class="p">(</span> <span class="p">(</span><span class="n">zero_vec</span><span class="p">,</span> <span class="o">-</span><span class="n">r</span><span class="p">,</span> <span class="n">one</span><span class="p">)</span> <span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>We can now find the solution to this problem.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="code"><pre> <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">linalg</span><span class="p">.</span><span class="n">inv</span><span class="p">(</span><span class="n">augL</span><span class="p">),</span> <span class="n">augR</span><span class="p">)</span>

 <span class="n">w</span> <span class="o">=</span> <span class="n">result</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
 <span class="n">alpha</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
 <span class="n">beta</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>We can verify that we are not spending more money then we have by computing the sum of <script type="math/tex">w_i</script>’s.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre> <span class="n">w</span><span class="p">.</span><span class="nb">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mf">1.0</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>This yields one, confirming that we are not spending money we don’t have.</p>

<p>To see how this portfolio performs, we can calculate the returns on both the In Sample (train) data and the OOS (test) data.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td><td class="code"><pre> <span class="n">eq_w</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">ones</span><span class="p">(</span><span class="n">num_stocks</span><span class="p">)</span> <span class="o">/</span> <span class="n">num_stocks</span> <span class="c1"># Ratios for an equally weighted portfolio
</span>
 <span class="n">train_cust_ret</span> <span class="o">=</span> <span class="p">[]</span>
 <span class="n">test_cust_ret</span> <span class="o">=</span> <span class="p">[]</span>
 <span class="n">test_eq_ret</span> <span class="o">=</span> <span class="p">[]</span>
 <span class="n">train_eq_ret</span> <span class="o">=</span> <span class="p">[]</span>
 
 <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">train_set</span><span class="p">.</span><span class="n">values</span><span class="p">:</span>
 <span class="n">train_cust_ret</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nb">sum</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">dot</span><span class="p">(</span><span class="n">w</span><span class="p">.</span><span class="n">T</span><span class="p">,</span> <span class="n">row</span><span class="p">)))</span>
 <span class="n">train_eq_ret</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">mean</span><span class="p">(</span><span class="n">row</span><span class="p">))</span>
 
 <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">test_set</span><span class="p">.</span><span class="n">values</span><span class="p">:</span>
 <span class="n">test_cust_ret</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nb">sum</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">dot</span><span class="p">(</span><span class="n">w</span><span class="p">.</span><span class="n">T</span><span class="p">,</span> <span class="n">row</span><span class="p">)))</span>
 <span class="n">test_eq_ret</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">mean</span><span class="p">(</span><span class="n">row</span><span class="p">))</span>

 <span class="n">train_cust_ret</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">train_cust_ret</span><span class="p">)</span>
 <span class="n">test_cust_ret</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">test_cust_ret</span><span class="p">)</span>
 <span class="n">test_eq_ret</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">test_eq_ret</span><span class="p">)</span>
 <span class="n">train_eq_ret</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">train_eq_ret</span><span class="p">)</span>

 <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_set</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">test_set</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_set</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">test_set</span><span class="p">))</span>
 
 <span class="n">plt</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">train_set</span><span class="p">)],</span> <span class="n">np</span><span class="p">.</span><span class="n">cumprod</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">train_cust_ret</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s">"Custom Portfolio, In Sample"</span><span class="p">)</span>
 <span class="n">plt</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">train_set</span><span class="p">):],</span> <span class="n">np</span><span class="p">.</span><span class="n">cumprod</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">test_cust_ret</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s">"Custom Portfolio, Out Of Sample"</span><span class="p">)</span>
 <span class="n">plt</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">train_set</span><span class="p">):],</span> <span class="n">np</span><span class="p">.</span><span class="n">cumprod</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">test_eq_ret</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s">"Equally weighted portfolio returns, In Sample"</span><span class="p">)</span>
 <span class="n">plt</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">train_set</span><span class="p">)],</span> <span class="n">np</span><span class="p">.</span><span class="n">cumprod</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">train_eq_ret</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s">"Equally weighted portfolio returns, Out Of Sample"</span><span class="p">)</span>
 <span class="n">plt</span><span class="p">.</span><span class="n">legend</span><span class="p">()</span>
 <span class="n">plt</span><span class="p">.</span><span class="n">title</span><span class="p">(</span><span class="s">"Portfolio returns vs Equally Weighted Portfolio Returns"</span><span class="p">)</span>
 <span class="n">plt</span><span class="p">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">"Days since beginning"</span><span class="p">)</span>
 <span class="n">plt</span><span class="p">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">"Return"</span><span class="p">)</span>
 <span class="n">plt</span><span class="p">.</span><span class="n">tight_layout</span><span class="p">()</span>
 <span class="n">plt</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p class="mx-auto d-block"><img src="/assets/blog/tech_blog/2020-09-22-tech-blog-Mathematical-Investing-1-Meandering-with-Markowitz/performance.png" alt="Portfolio Performance on In Sample and Out Of Sample data" />
<em>Portfolio Performance on In Sample and Out Of Sample data</em></p>

<p>As we expect, the In Sample performance is brilliant (this is akin to testing performance on training data), whereas the portfolio constructed from the In Sample data performs markedly less spectacularly in OOS data. Looking at the OOS results more closely, see that the Equally Weighted Portfolio generated a return of 30.11% whereas our portfolio managed a return of 35.62%. Sure, we’re winning, but not by much!</p>

<h3 id="another-way-of-thinking-about-portfolios">Another way of thinking about portfolios</h3>

<p>Till now, we have considered finding an optimal portfolio as an optimisation problem. Let’s take the problem finding the minimum variance portfolio:</p>

<script type="math/tex; mode=display">\begin{align}
 \underset{w}{\mathrm{argmin}}\ w^T \Sigma w\\
 \end{align}</script>

<p>We attempt to minimise the covariance matrix, which is a positive (semi-)definite matrix that does have an inverse. As the covariance matrix is symmetric all its eigenvectors are mutually orthogonal. The eigenvalues representing the risk associated with each eigenvector, which itself is a vector of weights of the constituents in that portfolio. As a result, choosing to build a portfolio corresponds to the eigenvector of the smallest eigenvalue will yield the least ‘risky’ portfolio. Also, the largest eigenvalue corresponds to the portfolio most strongly correlated with the market (the market created by the data that is used) and some techniques recommend ignoring the eigenvector associated with this eigenvalue as the whole aim is to decorrelate portfolio returns from the market as much as possible.</p>

<p>Why does this work? Well, to understand this it is best to look at stock returns as a signal.</p>

<p class="mx-auto d-block"><img src="/assets/blog/tech_blog/2020-09-22-tech-blog-Mathematical-Investing-1-Meandering-with-Markowitz/AAPL returns.png" alt="AAPL Returns" />
<em>AAPL returns</em></p>

<p>This signal as a whole is made up of a bunch of other signals which when combined in some fashion yield the signal we see. We can find these sub-signals by computing the eigendecomposition which yields a bunch of eigenvalues and eigenvectors. The eigenvalues indicate how much of a particular sub-signal contributes to the overall signal and so the eigenvector corresponding to the largest eigenvalue is supposed to explain the most (relatively) variance out of all the sub-signals. As we consider more sub-signals in order of decreasing eigenvalue, we get closer to constructing the original signal. For an excellent intuitive explanation of this, read <a href="https://quant.stackexchange.com/questions/26351/what-does-each-bar-in-the-empirical-average-eigenvalues-spectrum-of-the-correlat">this</a>.</p>

<p>With that out of the way, we can explore how to find some portfolios using an eigendecomposition method. We begin with the returns previously computed and calculate the mean and covariance matrices.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="code"><pre> <span class="n">returns</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">pct_change</span><span class="p">().</span><span class="n">dropna</span><span class="p">()</span>
 <span class="n">train_set</span> <span class="o">=</span> <span class="n">returns</span><span class="p">[:</span><span class="mi">252</span><span class="o">*</span><span class="mi">4</span><span class="p">]</span>
 <span class="n">test_set</span> <span class="o">=</span> <span class="n">returns</span><span class="p">[</span><span class="mi">252</span><span class="o">*</span><span class="mi">4</span><span class="p">:]</span>
 <span class="n">mu</span> <span class="o">=</span> <span class="n">train_set</span><span class="p">.</span><span class="n">mean</span><span class="p">().</span><span class="n">values</span><span class="p">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
 <span class="n">sigma</span> <span class="o">=</span> <span class="n">train_set</span><span class="p">.</span><span class="n">cov</span><span class="p">().</span><span class="n">values</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Computing the eigendecomposition yields the eigenvectors and eigenvalues.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
</pre></td><td class="code"><pre> <span class="n">eigvals</span><span class="p">,</span> <span class="n">eigvecs</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">linalg</span><span class="p">.</span><span class="n">eigh</span><span class="p">()</span>
 <span class="c1"># Eignevalues and eigenvectors are already ordered smallest-largest</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>From this, we can look at the components of each stock in each portfolio, after normalising the eigenvector to one.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="code"><pre> <span class="n">portfolio1</span> <span class="o">=</span> <span class="n">eigvecs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="p">.</span><span class="nb">sum</span><span class="p">(</span><span class="n">eigvecs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># Portfolio correspond to largest eigenvalue
</span> <span class="n">plt</span><span class="p">.</span><span class="n">bar</span><span class="p">(</span><span class="n">returns</span><span class="p">.</span><span class="n">columns</span><span class="p">[:</span><span class="mi">20</span><span class="p">],</span> <span class="n">portfolio1</span><span class="p">[:</span><span class="mi">20</span><span class="p">])</span>
 <span class="n">plt</span><span class="p">.</span><span class="n">title</span><span class="p">(</span><span class="s">"Portfolio 1"</span><span class="p">)</span>
 <span class="n">plt</span><span class="p">.</span><span class="n">tight_layout</span><span class="p">()</span>
 <span class="n">plt</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p class="mx-auto d-block"><img src="/assets/blog/tech_blog/2020-09-22-tech-blog-Mathematical-Investing-1-Meandering-with-Markowitz/portfolio1.png" alt="Portfolio1" />
<em>Portfolio 1</em></p>

<p>As mentioned before, we want a portfolio that is less correlated with the market and so we discard the largest eigenportfolio and instead choose the second largest. As in the previous section, we can visualise how well this portfolio performs. Note that here, we have placed no demand of a required rate of return.</p>

<p class="mx-auto d-block"><img src="/assets/blog/tech_blog/2020-09-22-tech-blog-Mathematical-Investing-1-Meandering-with-Markowitz/eigenportfolio.png" alt="Eigenportfolio" />
<em>Eigenportfolio</em></p>

<p>This highlights the performance of the riskiest portfolio that isn’t the market portfolio and we can use lower variance portfolios. Using the portfolio that corresponds to the smallest eigenvalue yields:</p>

<p class="mx-auto d-block"><img src="/assets/blog/tech_blog/2020-09-22-tech-blog-Mathematical-Investing-1-Meandering-with-Markowitz/eigenportfolio2.png" alt="Eigenportfolio" />
<em>Eigenportfolio</em></p>

<h3 id="what-next">What next?</h3>

<p>At this point, we are only beginning to realise the potential of Modern Portfolio Theory. This introduction leaves several questions unanswered:</p>

<ul>
  <li>
    <p>How can we try and eke more performance out of a portfolio by choosing a portfolio that is more likely to yield higher returns.</p>
  </li>
  <li>
    <p>How can we deal with sampling error?</p>
  </li>
  <li>
    <p>How can we ditch a bad strategy before we take too high a loss?</p>
  </li>
</ul>

<p>These are some of the questions I want to explore in future posts in this series. Given my snail’s pace posting rate it may be a while, but I will post in time. In the meantime, you may enjoy some of my other blog posts.</p>

      </article>

      
        <div class="blog-tags">
          Tags:
          
          
            <a href="/tags#tech">tech</a>
          
            <a href="/tags#quantitative finance">quantitative finance</a>
          
            <a href="/tags#investing">investing</a>
          
          
        </div>
      

      
        <!-- Check if any share-links are active -->




<section id = "social-share-section">
  <span class="sr-only">Share: </span>

  
    <a href="https://twitter.com/intent/tweet?text=Mathematical+Investing+1+-+Meandering+with+Markowitz&url=http%3A%2F%2Flocalhost%3A4000%2F2020-09-22-tech-blog-Mathematical-Investing-1-Meandering-with-Markowitz%2F"
      class="btn btn-social-icon btn-twitter" title="Share on Twitter">
      <span class="fab fa-fw fa-twitter" aria-hidden="true"></span>
      <span class="sr-only">Twitter</span>
    </a>
  

  
    <a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Flocalhost%3A4000%2F2020-09-22-tech-blog-Mathematical-Investing-1-Meandering-with-Markowitz%2F"
      class="btn btn-social-icon btn-facebook" title="Share on Facebook">
      <span class="fab fa-fw fa-facebook" aria-hidden="true"></span>
      <span class="sr-only">Facebook</span>
    </a>
  

  
    <a href="https://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Flocalhost%3A4000%2F2020-09-22-tech-blog-Mathematical-Investing-1-Meandering-with-Markowitz%2F"
      class="btn btn-social-icon btn-linkedin" title="Share on LinkedIn">
      <span class="fab fa-fw fa-linkedin" aria-hidden="true"></span>
      <span class="sr-only">LinkedIn</span>
    </a>
  

  

</section>



      

      <ul class="pagination blog-pager">
        
        <li class="page-item previous">
          <a class="page-link" href="/2020-09-01-tech-blog-Relative-Momentum-Trading-Strategy/" data-toggle="tooltip" data-placement="top" title="Relative (Cross-Sectional) Momentum Trading Strategy">&larr; Previous Post</a>
        </li>
        
        
        <li class="page-item next">
          <a class="page-link" href="/2021-06-16-tech-blog-A-Summary-of-Action-Recognition-So-Far/" data-toggle="tooltip" data-placement="top" title="A Summary of Action Recognition So Far">Next Post &rarr;</a>
        </li>
        
      </ul>
              
  
  
  

  



    </div>
  </div>
</div>


    <footer>
  <div class="container-md beautiful-jekyll-footer">
    <div class="row">
      <div class="col-xl-8 offset-xl-2 col-lg-10 offset-lg-1">
      <ul class="list-inline text-center footer-links"><li class="list-inline-item">
    <a href="mailto:padmanaba.srinivasan16@imperial.ac.uk" title="Email me">
      <span class="fa-stack fa-lg" aria-hidden="true">
        <i class="fas fa-circle fa-stack-2x"></i>
        <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
      </span>
      <span class="sr-only">Email me</span>
   </a>
  </li><li class="list-inline-item">
    <a href="https://github.com/dangerbot3pic" title="GitHub">
      <span class="fa-stack fa-lg" aria-hidden="true">
        <i class="fas fa-circle fa-stack-2x"></i>
        <i class="fab fa-github fa-stack-1x fa-inverse"></i>
      </span>
      <span class="sr-only">GitHub</span>
   </a>
  </li><li class="list-inline-item">
    <a href="https://linkedin.com/in/padmanaba-srinivasan-b67bb1137" title="LinkedIn">
      <span class="fa-stack fa-lg" aria-hidden="true">
        <i class="fas fa-circle fa-stack-2x"></i>
        <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
      </span>
      <span class="sr-only">LinkedIn</span>
   </a>
  </li><li class="list-inline-item">
    <a href="https://steamcommunity.com/id/dangerbot3pic" title="Steam">
      <span class="fa-stack fa-lg" aria-hidden="true">
        <i class="fas fa-circle fa-stack-2x"></i>
        <i class="fab fa-steam fa-stack-1x fa-inverse"></i>
      </span>
      <span class="sr-only">Steam</span>
   </a>
  </li></ul>

      
      <p class="copyright text-muted">
      
        Padmanaba Srinivasan
        &nbsp;&bull;&nbsp;
      
      2021

      

      
      </p>
      <!-- Please don't remove this, keep my open source work credited :) -->
      <p class="theme-by text-muted">
        Theme by
        <a href="https://beautifuljekyll.com">beautiful-jekyll</a>
      </p>
      </div>
    </div>
  </div>
</footer>

  
    
  
    
  <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>


  
    
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>


  
    
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>


  



  
    <!-- doing something a bit funky here because I want to be careful not to include JQuery twice! -->
    
      <script src="/assets/js/main.js"></script>
    
  






  
  </body>
</html>
